---
title: "analysis"
author: "Maya Sollen-Norrlin"
date: "2023-02-27"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
summary(cars)
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.


Load libraries
```{r}

#library(psych)
#library(MASS)
library(tidyverse)
library(gridExtra)
library(rstatix)
library(car)
library(MANOVA.RM)

```
Read in csv file created at the end of the data-wrangling script
```{r}

tidyData <- read.csv("chemistry-data-tidy.csv")

```

Look at the data
```{r}

head(tidyData)

```

```{r}

str(tidyData)

```
Rename columns so they're easier to write.
```{r}

tidyData<- tidyData %>% 
  rename(
   "NH4 (mg/kg)" = NH4..mg.kg.,
   "TON (mg/kg)" = TON..mg.kg.,
   "K (mg/kg)" = K..mg.kg.,
   "NO2 (mg/kg)" = NO2..mg.kg.,
   "NO3 (mg/kg)" = NO3..mg.kg.,
   "Conductivity (mV)" = Conductivity..mV.,
   "Moisture (%)" = Moisture....
  )

head(tidyData)


```
Convert to factors so that ANOVA and Tukey's work
```{r}
tidyData$Weeks <- as.factor(tidyData$Weeks)

tidyData$Treatment <- as.factor(tidyData$Treatment)

str(tidyData)
```
Turning data into long format (if necessary)
```{r}

longData <- tidyData %>%
  dplyr::select(-2) %>%
  pivot_longer(cols = 3:9,
               names_to = "Chemistry variable",
               values_to = "Result")

#longData$Sample.ID <- paste(longData$Sample.ID, 1:nrow(longData), sep = "-")

head(long_data)
```

Summary statistics
```{r}

#tidyData %>% 
 # group_by(Treatment, Weeks) %>%
  #get_summary_stats(type = "mean_sd")

```

Testing raw data for normality and equal variance
```{r}
for (i in 3:9) {
  column <- names(tidyData[i])
  
  shapiro1 <- shapiro.test(tidyData[,i])
  
  levene <- leveneTest(tidyData[,i] ~ Treatment*Weeks, data = tidyData)
   
  print(column)
  print(shapiro1)
  print(levene)
}


```


ANOVA and Tukey's, also testing residuals for normality and plotting residual histogram and QQ-plot
```{r}

for(i in 3:9) {
  column <- names(tidyData[i])
  
  # Conduct ANOVA and store residuals
  avz <- aov(tidyData[,i] ~ Treatment + Weeks, data = tidyData)
  residuals <- resid(avz)
  
  # Test normality of residuals using Shapiro-Wilks test
  shapiro <- shapiro.test(residuals)
  
  
  
  # Conduct Tukey HSD post-hoc test
  tukey <- TukeyHSD(avz)
  
  # Plot histogram and QQ plot of residuals
  par(mfrow = c(1, 2))
  hist(residuals, main = paste("Histogram of Residuals for", column))
  qqnorm(residuals, main = paste("QQ Plot of Residuals for", column))
  qqline(residuals)
  
  # Print results
  cat("Column:", column, "\n")
  cat("ANOVA:\n")
  print(summary(avz))
  cat("Shapiro-Wilk test for normality of residuals:\n")
  print(shapiro)
  cat("Tukey HSD post-hoc test:\n")
  print(tukey)
}


```
ANOVA loop saving only ANOVA results to file
```{r}
# Create an empty data frame to store results
results_df <- data.frame(Column = character(),
                          F_value = numeric(),
                          P_value = numeric(),
                          Normality_p_value = numeric(),
                          stringsAsFactors = FALSE)

for(i in 3:9) {
  column <- names(tidyData[i])
  
  # Conduct ANOVA and store residuals
  avz <- aov(tidyData[,i] ~ Treatment + Weeks, data = tidyData)
  residuals <- resid(avz)
  
  # Test normality of residuals using Shapiro-Wilk test
  shapiro <- shapiro.test(residuals)
  
  # Conduct Tukey HSD post-hoc test
  tukey <- TukeyHSD(avz)
  
  # Extract ANOVA results and store in a data frame
  result <- summary(avz)
  f_value <- result[[1]][1, 1]
  p_value <- result[[1]][1, 5]
  normality_p_value <- shapiro$p.value
  row <- data.frame(Column = column, F_value = f_value, P_value = p_value,
                    Normality_p_value = normality_p_value, stringsAsFactors = FALSE)
  
  # Append row to results data frame
  results_df <- rbind(results_df, row)
  
  # Plot histogram and QQ plot of residuals
  par(mfrow = c(1, 2))
  hist(residuals, main = paste("Histogram of Residuals for", column))
  qqnorm(residuals, main = paste("QQ Plot of Residuals for", column))
  qqline(residuals)
  
  # Print results
  cat("Column:", column, "\n")
  cat("ANOVA:\n")
  print(result)
  cat("Shapiro-Wilk test for normality of residuals:\n")
  print(shapiro)
  cat("Tukey HSD post-hoc test:\n")
  print(tukey)
}

# Save results data frame to a file
write.csv(results_df, "results.csv", row.names = FALSE)



```


ANOVA loop saving ANOVA & Tukey's results to files
```{r}

# Create an empty data frame to store results
results_df <- data.frame(Column = character(),
                          F_value = numeric(),
                          P_value = numeric(),
                          Normality_p_value = numeric(),
                          stringsAsFactors = FALSE)

# Create an empty data frame to store Tukey's test results
tukey_df1 <- data.frame(Column = character(),
                        Comparison = character(),
                        Difference = numeric(),
                        Tukey_P_value = numeric(),
                        stringsAsFactors = FALSE)
tukey_df2 <- data.frame(
                        Comparison2 = character(),
                        Difference2 = numeric(),
                        Tukey_P_value2 = numeric(),
                        stringsAsFactors = FALSE)

for(i in 3:9) {
  column <- names(tidyData[i])

  # Conduct ANOVA and store residuals
  avz <- aov(tidyData[,i] ~ Treatment + Weeks, data = tidyData)
  residuals <- resid(avz)
  
  # Test normality of residuals using Shapiro-Wilk test
  shapiro <- shapiro.test(residuals)
  
  # Conduct Tukey HSD post-hoc test
  tukey <- TukeyHSD(avz)
  
  # Extract ANOVA results and store in a data frame
  result <- summary(avz)
  f_value <- result[[1]][1, 1]
  p_value <- result[[1]][1, 5]
  normality_p_value <- shapiro$p.value
  row <- data.frame(Column = column, F_value = f_value, P_value = p_value,
                    Normality_p_value = normality_p_value, stringsAsFactors = FALSE)
  
  # Append row to results data frame
  results_df <- rbind(results_df, row)
  
  # Extract Tukey's test results and store in a data frame
   comparisons <- row.names(tukey[[1]])
    for (j in 1:nrow(tukey[[1]])) {
      comparison <- comparisons[j]
      difference <- tukey[[1]][j, 1]
      tukey_p_value <- tukey[[1]][j, 4]
      tukey_row <- data.frame(Column = column,
                               Comparison = comparison,
                               Difference = difference,
                               Tukey_P_value = tukey_p_value,
                               stringsAsFactors = FALSE)
      tukey_df1 <- rbind(tukey_df1, tukey_row)
    }
  comparisons2 <- row.names(tukey[[2]])
  for (k in 1:nrow(tukey[[2]])) {
    comparison2 <- comparisons2[k]
    difference2 <- tukey[[2]][k, 1]
    tukey_p_value2 <- tukey[[2]][k, 4]
    tukey_row2 <- data.frame( 
                              Comparison2 = comparison2,
                              Difference2 = difference2,
                              Tukey_P_value2 = tukey_p_value2,
                              stringsAsFactors = FALSE)
    tukey_df2 <- rbind(tukey_df2, tukey_row2)
  }
  tukey_results <- cbind(tukey_df1, tukey_df2)
  # Plot histogram and QQ plot of residuals
  par(mfrow = c(1, 2))
  hist(residuals, main = paste("Histogram of Residuals for", column))
  qqnorm(residuals, main = paste("QQ Plot of Residuals for", column))
  qqline(residuals)
}

# Save results to file
write.csv(results_df, file = "results.csv", row.names = FALSE)
write.csv(tukey_results, file = "tukey_results.csv", row.names = FALSE)


```

MANOVA on pH only
```{r}

pH_data <- tidyData %>%
  select(Sample.ID, pH, Treatment, Weeks)
  

head(pH_data,20)


```

```{r}

str(pH_data)
```

```{r}

pH_summary <- pH_data %>%
  group_by(Treatment, Weeks,) %>%
  get_summary_stats(pH, type = "mean_sd")
data.frame(pH_summary)


```
Checking for outliers
```{r}

pH_outlier <- pH_data %>%
  group_by(Treatment, Weeks) %>%
  identify_outliers(pH)
data.frame(pH_outlier)

```


```{r}
ggplot(pH_data, aes(sample = pH), ggtheme = bw()) +
  stat_qq() +
  facet_grid(Treatment ~ Weeks)


```

```{r}

pH_data$Sample.ID <- paste(pH_data$Sample.ID, 1:nrow(tidyData), sep = "-")

pH_data <- pH_data %>%
  dplyr::arrange(Treatment, Weeks, Sample.ID) %>%
  dplyr::mutate(ID = 1:nrow(pH_data))



str(pH_data)

```

```{r}
pH.MAN <- multRM(pH ~ Treatment*Weeks, data = pH_data,
                 subject = "ID", within = c("Weeks", "Treatment" ))

summary(pH.MAN)
```







```{r}

```


```{r}

longData %>%
  dplyr::group_by(Compound, Treatment, Weeks) %>%
  summarise(N = n())

```

MANOVA with long data - currently not working
```{r}


modell <- multRM(Result ~ Weeks*Compound*Treatment, data = longData,
                 subject = "Sample.ID", within = c("Compound", "Treatment"))

summary(modell)


```

How to add a unique number on to each sample id (if needed):
```{r}


tidyData$Sample.ID <- paste(tidyData$Sample.ID, 1:nrow(tidyData), sep = "-")

head(tidyData)
```

```{r}
summary(tidyData)

```

```{r}
levels(tidyData$Weeks)
```

```{r}
levels(tidyData$Treatment)
```

```{r}

  


```


```{r}


modell <- multRM(cbind(pH, `Conductivity (mV)`, `NO3 (mg/kg)`, `NO2 (mg/kg)`, `NH4 (mg/kg)`, `TON (mg/kg)`,  `K (mg/kg)`)~Weeks*Treatment, data = tidyData,
                 subject = "Sample.ID", within = c("Treatment", "Weeks"))

summary(modell)


```

```{r}
tidyData[,!complete.cases(tidyData)]

which(is.na(tidyData))
```



```{r}

pH

```
